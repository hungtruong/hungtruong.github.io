WEBVTT

00:00:00.000 --> 00:00:04.715
Cloning Zwift on iOS Part 3: HealthKit and a WatchOS App!

00:00:06.215 --> 00:00:08.532
Published on May 03, 2019.

00:00:09.532 --> 00:00:16.085
I’ve been a bit slow to update my blog series about trying to make a clone of Zwift, but not because I’ve stopped working on it.

00:00:16.585 --> 00:00:24.896
Rather, I’ve been able to use the “MVP” of what I’ve built so far in parts 1 and 2 , and I was finding that the time I spent working on my app could be used actually working out.

00:00:25.396 --> 00:00:38.743
Like, I literally would write an implementation of something, but it would take so much of my time that I couldn’t test it out and I’d have to go to bed… Still, I was missing a few important features in my app, so I’ve been slowly working on them in between working on my fitness.

00:00:39.743 --> 00:00:41.820
Hooking up the Apple Watch

00:00:43.320 --> 00:00:49.873
One of the great things about Zwift is how much support they provide for different fitness accessories, including the Apple Watch.

00:00:50.373 --> 00:00:57.646
Unfortunately, the Apple Watch hardware is not set up to allow arbitrary Bluetooth connections like my exercise bike was in part 1.

00:00:58.146 --> 00:01:03.899
Instead, to access the user’s health information like heart rate, you need to write a full blown WatchOS app!

00:01:04.899 --> 00:01:13.530
Luckily, this wasn’t my first rodeo as I worked on the Apple Watch app for Starbucks, so I was able to add a Watch app extension target in my project pretty quickly.

00:01:14.530 --> 00:01:24.360
I Googled for how to get a user’s heart rate programmatically, came across a promising StackOverflow post with a link to a Github project , and was able to get it implemented myself.

00:01:24.860 --> 00:01:28.776
However, as I looked at the copy-pasta code, it seemed sort of wrong to me.

00:01:29.276 --> 00:01:39.105
The code was starting a workout session, but then created an object query that would run a closure whenever a new heart rate sample (older than a certain date) was added by the workout.

00:01:39.605 --> 00:01:46.478
This seems like a really roundabout way to get heart rate samples, and I wondered if Apple had a better API to accomplish this.

00:01:47.478 --> 00:01:49.396
Implementing HealthKit

00:01:50.896 --> 00:01:55.291
I ended up finding some Apple sample code that showed a better way to fetch heart rate data.

00:01:55.791 --> 00:02:02.743
The solution is to use some new features introduced in WatchOS 5 that allow for creation of a workout directly on the Apple Watch.

00:02:03.243 --> 00:02:07.399
The Apple doc I linked explains it pretty well, but the steps are:

00:02:08.399 --> 00:02:11.755
Ask the user for permission to track their heart rate data

00:02:12.755 --> 00:02:19.947
Create a workout configuration (e.g. an indoor cycling workout) and a workout session, along with its associated workout builder

00:02:20.947 --> 00:02:25.103
Start the session and tell the workout builder to start collecting data samples

00:02:26.103 --> 00:02:33.295
Respond to the delegate method “workoutBuilder(_:didCollectDataOf:)” to collect a bunch of samples, including heart rate information

00:02:34.295 --> 00:02:36.612
In code it looks something like this:

00:02:37.612 --> 00:02:50.399
Rather than add some UI to the watch app to start a workout session, the iPhone version of HKHealthStore has a function called startWatchApp(with:completion:) which will send a workout configuration to the watch to facilitate the creation of a workout.

00:02:50.899 --> 00:03:03.526
All I need to do is call that function when my workout on the iPhone app starts and my watch app will respond by starting a HealthKit workout session which starts measuring things like heart rate (and calculating its own estimated calories burned).

00:03:04.526 --> 00:03:11.159
I was now able to get the heart rate as the watch was reading it, and update whatever display on the watch I wanted to.

00:03:11.659 --> 00:03:13.817
That was only half the story though.

00:03:14.317 --> 00:03:19.751
In Zwift the heart rate shows up in the user interface, and I wanted to mimic that myself.

00:03:20.251 --> 00:03:27.683
Since I couldn’t access the workout session directly from the phone I’d have to send the heart rate info back to the main app from the watch.

00:03:28.683 --> 00:03:30.201
Back to the App

00:03:31.701 --> 00:03:36.736
This blog post isn’t about Watch apps, so I won’t go over that aspect of this feature too much.

00:03:37.236 --> 00:03:43.789
I basically used the WatchConnectivity session to send messages back to the app with a dictionary containing the new heart rate.

00:03:44.789 --> 00:03:56.936
And after all of that programming, I’d like to present you with the most difficult video I’ve ever shot: on an iPad, while balancing on an exercise bike, recording both my wrist watch with my heart rate AND the app showing the exact same heart rate!

00:03:57.936 --> 00:04:12.802
I also rigged up an initial interface that shows which workout segment I’m on, the next segment coming up, the progress through the segment and my progress for the entire workout, along with stats like calories burned (determined by the bike), cadence and distance traveled.

00:04:13.802 --> 00:04:16.039
At this point I have a pretty functional app!

00:04:16.539 --> 00:04:21.334
But seeing the extensive APIs of HealthKit made me want to add more and more to my app.

00:04:21.834 --> 00:04:23.752
This is scope creep in action.

00:04:24.252 --> 00:04:29.686
See the documentation of HKWorkoutBuilder to see all of the data and metadata you can store.

00:04:30.186 --> 00:04:35.540
I ended up sending a few more messages from the app back to the watch so I could store more data to the workout:

00:04:36.540 --> 00:04:42.214
At the end of a workout, I send the start and end times, along with the total calories burned and distance traveled.

00:04:42.714 --> 00:04:49.986
This isn’t really necessary because the watch already makes a guess about the calories burned and the distance isn’t real because it’s on a stationary bike.

00:04:50.486 --> 00:04:54.082
But I thought it might be interesting to see how that data is represented.

00:04:55.082 --> 00:05:01.315
I also toyed around with sending segment data but I haven’t seen it visually represented anywhere in the workout view.

00:05:01.815 --> 00:05:13.003
I wanted to see more detail about the workout in the Apple Activity app so I also sent the name of the workout as the HKMetadataKeyWorkoutBrandName value, though I’m not sure that’s what it’s intended for!

00:05:13.503 --> 00:05:18.618
Here’s what the workouts look like in the Activity app and the Health app’s workout data:

00:05:19.618 --> 00:05:25.691
One more fun but optional thing I thought of and added was a wrist tap reminder when I got close to the end of a segment.

00:05:26.191 --> 00:05:38.738
Sometimes I’m just in the zone and not paying attention to the fact that I need to ramp up or ramp down for the next section, so when there’s 5 seconds left in a segment I send a message to the watch from the phone to tap my wrist and send a reminder:

00:05:39.738 --> 00:05:46.851
One of the nice things about writing your own workout app is that you don’t need to wait for a third party developer to implement any ideas you have for the app!

00:05:47.351 --> 00:05:49.588
I think that’s actually the only nice thing…

00:05:50.588 --> 00:05:53.225
Anyway, I’m pretty happy with the results.

00:05:53.725 --> 00:05:59.719
Next up, I plan on adding a bit of visual polish to the interface and maybe even create an app icon!

00:06:00.219 --> 00:06:09.329
I also want to aggregate the data like heart rate info, watt effort, etc and keep track of statistics and chart the data, perhaps in real time.

00:06:09.829 --> 00:06:17.980
I find it very motivating to compare my effort in the same exact workout across different days to see if I’m improving (maybe by measuring heart rate average).

00:06:18.980 --> 00:06:26.972
As usual, my changes are in Github in case you happen to have the same exact exercise bike as me or are curious how I implemented certain things.
