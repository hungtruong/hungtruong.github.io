WEBVTT

00:00:00.000 --> 00:00:02.880
Hardcore Rails/Server Troubleshooting Session!

00:00:04.380 --> 00:00:06.380
Published on July 15, 2008.

00:00:07.380 --> 00:00:14.740
So early last night, I noticed that one of my sites, Anime Nano, was flipping out and throwing 502 proxy errors.

00:00:15.240 --> 00:00:22.920
I tried to do some simple troubleshooting but it seems as though the problem came very suddenly, and I figured it might go away very suddenly as well.

00:00:23.420 --> 00:00:27.660
The thing about this particular problem was that I had made no changes to the server.

00:00:28.160 --> 00:00:30.000
So the problem should fix itself!

00:00:30.500 --> 00:00:32.820
Unfortunately, life is not so simple.

00:00:33.820 --> 00:00:39.900
When I woke up in the morning, not only was the site still throwing errors, it was also affecting my other websites as well.

00:00:40.400 --> 00:00:45.840
MapsKrieg, Notecentric, Basugasubakuhatsu, etc.

00:00:46.340 --> 00:00:48.580
So I figured I should find out what is going on.

00:00:49.080 --> 00:00:54.680
I sent a support request to MediaTemple, my host, in case it might’ve been something on their end.

00:00:55.180 --> 00:01:01.980
It took a while for them to reply, but they eventually just told me it was something taking up all the memory and that I should try to optimize the site.

00:01:02.480 --> 00:01:03.600
Not too helpful.

00:01:04.100 --> 00:01:07.860
But I don’t really expect MediaTemple to provide this kind of support anyway.

00:01:08.360 --> 00:01:10.520
And it turned out it wasn’t their fault.

00:01:11.520 --> 00:01:14.720
Upon closer inspection, the site was really behaving weird.

00:01:15.220 --> 00:01:21.380
I could tell by the logs that the site was actually rendering things, but it always took about 189 seconds.

00:01:21.880 --> 00:01:23.560
This was odd.

00:01:24.060 --> 00:01:31.900
I’ve had experiences before where the rendering took less than a second but the page still took more than 3 seconds to load.

00:01:32.400 --> 00:01:34.160
But 189 seconds!

00:01:34.660 --> 00:01:36.020
That was a bit too much.

00:01:37.020 --> 00:01:42.380
I had suspected it was something to do with the mongrel cluster that I had set the site up to run on.

00:01:42.880 --> 00:01:49.680
Basically, I followed the script that MediaTemple provided and I still don’t have a great understanding of how mongrel cluster works.

00:01:50.180 --> 00:01:51.620
That’s definitely bad.

00:01:52.620 --> 00:01:55.820
I tried stripping the view of everything but the content for layout.

00:01:56.320 --> 00:02:03.360
I got rid of before_filters and tried running the site on the mongrel clusters as well as the webrick server on port 3000.

00:02:03.860 --> 00:02:05.300
The same thing happened.

00:02:05.800 --> 00:02:08.120
It took way too long for the site to load.

00:02:08.620 --> 00:02:17.500
Thinking it might be easier to test on my local machine, I got the site and database from svn and mysql and, strangely, it worked fine on my PC.

00:02:18.500 --> 00:02:20.820
Now things were slowly fitting together.

00:02:21.320 --> 00:02:27.880
I was reminded of a post that someone made on Anime Nano about how their feed wasn’t being aggregated into the site.

00:02:28.380 --> 00:02:31.180
Apparently their feed was unreachable from my server.

00:02:31.680 --> 00:02:37.520
I had previously chalked this up to weirdness on their server, but I wondered if it wasn’t a problem on my server.

00:02:38.020 --> 00:02:43.860
The thing about each pageload taking almost exactly 189 seconds pointed to a timeout issue.

00:02:44.360 --> 00:02:48.760
Then I realized there was a piece of code in Anime Nano that I hadn’t written.

00:02:49.260 --> 00:02:53.980
It was a plugin for Text Link Ads that I used for some ads on the bottom of the site.

00:02:54.480 --> 00:02:59.280
That plugin was grabbing a feed of ads and parsing it to show links automatically on the site.

00:03:00.280 --> 00:03:06.680
If their site was unreachable, it’s possible that Anime Nano was just waiting on grabbing that snippet of code and timing out.

00:03:07.180 --> 00:03:08.860
And that’s exactly what happened.

00:03:09.360 --> 00:03:13.520
I commented out the text for the ads and the site immediately started working again.

00:03:14.020 --> 00:03:18.260
I’ll have to look into how I can prevent this from happening again before reinstating the ads.

00:03:19.260 --> 00:03:22.140
So what did I learn from this whole experience?

00:03:22.640 --> 00:03:30.640
You should probably understand how code works before randomly integrating it into your site (I added that code a long, long time ago and forgot about it).

00:03:31.140 --> 00:03:36.740
Also, relying on a third party to provide some information before loading your site is just plain stupid.

00:03:37.240 --> 00:03:41.320
I can’t believe how badly thought out I had made the organization of the site.
