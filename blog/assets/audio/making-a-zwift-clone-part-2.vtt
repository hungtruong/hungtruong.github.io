WEBVTT

00:00:00.000 --> 00:00:06.793
Making an iOS Zwift Clone to Save $15 a Month! Part 2: Reverse Engineering a Workout

00:00:08.293 --> 00:00:10.770
Published on April 07, 2019.

00:00:11.770 --> 00:00:22.958
Last time, on “Making an iOS Zwift Clone to Save $15 a Month” I wrote about learning Core Bluetooth to connect to my exercise bike and get data streaming directly to my app .

00:00:23.958 --> 00:00:34.268
Since writing that article, I cleaned up the implementation of the Core Bluetooth service a bit and started supporting some additional data like distance, calories burned and cycling cadence.

00:00:35.268 --> 00:00:46.216
While cycling on my exercise bike and staring at these numbers is fun, the built-in screen on my bike already shows these numbers, so I essentially recreated a subset of the official ergData app so far.

00:00:47.216 --> 00:00:54.648
I realized the next challenge would be to start a guided workout in my app and show the target wattage alongside my actual wattage on the bike.

00:00:55.648 --> 00:00:56.927
Enter the Workout

00:00:58.427 --> 00:01:01.943
Zwift workouts seem pretty simple to begin with.

00:01:02.443 --> 00:01:05.959
You can set up a number of workout segments to guide your workout.

00:01:06.459 --> 00:01:11.014
There are warmups, steady states, intervals, free ride sections and cool-downs.

00:01:11.514 --> 00:01:15.989
At any given point in your workout, Zwift will tell you to put in a certain amount of effort.

00:01:16.489 --> 00:01:20.005
You just try to get your watt number to match what Zwift wants you to do.

00:01:21.005 --> 00:01:28.757
At first I figured I could come up with my own way of representing workouts, but that would also require me to re-create all of the workouts I usually use on Zwift.

00:01:29.257 --> 00:01:36.129
Zwift also has a nice workout editor that can use to edit preset workouts or create completely new ones on your own.

00:01:37.129 --> 00:01:44.801
I discovered that if you copy an existing workout to edit it, the workout will be saved as user data and will be synced between all devices.

00:01:45.301 --> 00:01:47.539
How is the workout data saved, you ask?

00:01:48.039 --> 00:01:50.756
No, not as JSON as a sane developer would use.

00:01:51.256 --> 00:01:54.772
It’s XML. Okay, so technically it’s a .

00:01:55.272 --> 00:01:58.388
zwo file but I know what XML looks like!

00:01:58.888 --> 00:02:01.605
Here’s a sample of an exported workout file:

00:02:02.605 --> 00:02:06.521
So I went ahead and implemented an XMLParser in Swift to turn .

00:02:07.021 --> 00:02:09.418
zwo files into my own Workout struct.

00:02:09.918 --> 00:02:17.670
I won’t bore you with the implementation details but it was kind of a walk down memory lane dealing with the delegation-based API of XMLParser.

00:02:18.170 --> 00:02:24.403
I’m surprised there isn’t a more modern solution in Foundation but I’m guessing it’s because most people have moved on from XML.

00:02:25.403 --> 00:02:27.640
Let’s Reverse Engineering

00:02:29.140 --> 00:02:30.339
By reading the .

00:02:30.839 --> 00:02:37.951
zwo files, I was able to figure out how Zwift represents their workouts and basically reverse engineer the structure of a workout:

00:02:38.951 --> 00:02:44.625
Warmups have a duration, a low and high power (which is a percentage of FTP ).

00:02:45.125 --> 00:02:50.000
The warmup begins at the low power and steadily ramps up to the high power by the end of the segment.

00:02:51.000 --> 00:02:55.075
SteadyStates are the simplest, with just a duration and power.

00:02:56.075 --> 00:03:01.829
Intervals are the most complicated, with a repeat number, onDuration, offDuration, onPower and offPower.

00:03:02.329 --> 00:03:08.083
The intervals segment goes between the high and low power levels, and repeats a certain number of times.

00:03:08.583 --> 00:03:14.176
I didn’t want to deal with the extra complexity of this type so I just wrote some code to expand them out into SteadyStates.

00:03:15.176 --> 00:03:17.893
Cooldowns are like warmups but in reverse.

00:03:18.893 --> 00:03:27.924
There are also some other things like text captions that appear during a workout, free ride segments and cadence settings that I didn’t bother to implement because I don’t use them.

00:03:28.424 --> 00:03:35.216
The cadence stuff makes sense if you’re using a smart trainer but my bike doesn’t support automatically changing resistance anyway.

00:03:36.216 --> 00:03:44.128
I decided to represent the WorkoutSegment as a Swift enum since it needs to support a bunch of different formats with varying levels of complexity.

00:03:44.628 --> 00:03:50.861
I’m actually kinda curious how the Zwift team ended up representing these and if they did something similar.

00:03:51.861 --> 00:04:03.529
From here it’s pretty simple to get stuff like the total duration or the target wattage for a particular time offset, whether I need to calculate that (in the case of a warmup or cooldown) or if I just return the constant value.

00:04:04.529 --> 00:04:15.718
Aside from representing the workout segments, the actual workout object will consist of things like the name, description, FTP and other information that pertains to the state of the workout like time elapsed.

00:04:16.218 --> 00:04:23.730
I wrote a function that takes the current time elapsed in the workout, loops through and finds the corresponding segment and returns the desired wattage.

00:04:24.230 --> 00:04:27.666
There might be a more efficient way to do that but for now it works.

00:04:28.666 --> 00:04:36.578
I also added some things to my project for displaying and choosing workouts from a list, and actually displaying the target wattage alongside actual wattage.

00:04:37.078 --> 00:04:42.192
I want to improve the interface now since it’s terrible, but I’ll save that for another blog post.

00:04:42.692 --> 00:04:51.243
If you want to check out the project, it’s all here on Github , including the playgrounds I used to test out the workout segment logic before adding it to the Xcode project.

00:04:52.243 --> 00:05:00.474
Next on my list of tasks is to make the workout interface a lot prettier/usable, and to add heart rate information from my Apple Watch.
