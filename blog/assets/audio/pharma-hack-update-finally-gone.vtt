WEBVTT

00:00:00.000 --> 00:00:02.637
Pharma Hack Update: Finally Gone

00:00:04.137 --> 00:00:07.014
Published on January 13, 2013.

00:00:08.014 --> 00:00:13.847
A good while ago, I wrote a blog post about how my blog was pharma hacked , and I thought I had gotten rid of it.

00:00:14.347 --> 00:00:21.380
I was actually extremely wrong, and it’s taken about half a year of off/on again fiddling to get rid of the infection for good.

00:00:21.880 --> 00:00:25.955
I thought I’d write up what I did in case anyone else has issues with this hack.

00:00:26.955 --> 00:00:31.031
In order to remove it, I tried searching for solutions from other bloggers.

00:00:31.531 --> 00:00:42.160
They got me to a certain point, but after following the directions and letting my blog sit for a week or so, I’d use the Google Webmasters feature to “fetch as Googlebot” and find that my site was reinfected.

00:00:43.160 --> 00:00:48.114
Here’s a step by step summary of what I had to do to finally get rid of the nasty pharma hack.

00:00:49.114 --> 00:00:54.948
I downloaded the latest tar.gz from WordPress here and extracted it to my root web directory.

00:00:55.448 --> 00:01:07.596
My blog lives in the subfolder “/blog/” so I just moved the wp-config.php file from /blog/ to the /wordpress directory, then I renamed the blog folder to something else and renamed wordpress to blog.

00:01:08.096 --> 00:01:13.210
I found that I’d also have to re-set the permalink settings to get pages besides my home page to show up correctly.

00:01:14.210 --> 00:01:18.925
My main mistake was copying the wp-contents subfolders back to the /blog/ directory.

00:01:19.425 --> 00:01:24.699
I assumed that the main infected file (wp-loads.php) was the only culprit.

00:01:25.199 --> 00:01:33.190
It turned out that I also had multiple php backdoors in my wp-contents directories, in /plugins, /themes, and even /uploads.

00:01:34.190 --> 00:01:39.225
I basically had to re-download anything in plugins and themes so that I knew those directories would be fresh.

00:01:39.725 --> 00:01:43.321
I ran a command to delete anything in /uploads that was a .

00:01:43.821 --> 00:01:46.937
php file, as that was how the backdoor worked.

00:01:47.437 --> 00:01:49.195
I believe it was something like

00:01:50.195 --> 00:01:55.310
find /path/to/uploads -name "*.php" | xargs rm

00:01:56.310 --> 00:01:59.586
but you probably want to double check that before running it on your server.

00:02:00.586 --> 00:02:06.340
I also noticed that some backdoors existed in the root of my web directory, where I keep my portfolio.

00:02:06.840 --> 00:02:12.194
If you have other directories besides your blog in your web root, it’s probably worthwhile to check those out.

00:02:13.194 --> 00:02:16.950
At this point I was pretty close to having a clean WordPress install.

00:02:17.450 --> 00:02:21.046
But for some reason my site would still eventually fall to the pharma hack.

00:02:21.546 --> 00:02:27.299
I checked my server logs and it looked like someone was modifying header.php in my theme directory from the admin panel.

00:02:27.799 --> 00:02:32.035
This was pretty surprising because I thought I had my password locked down pretty tight.

00:02:32.535 --> 00:02:41.165
I am actually still not sure whether the password was compromised, or some other feature in php (or a cookie) allowed the hacker to access the admin theme editor.

00:02:41.665 --> 00:02:49.177
Either way I’m pretty sure the header.php was hacked to write a new backdoor file which would then create other backdoors. Pretty smart!

00:02:50.177 --> 00:02:55.931
To fix this, I put another layer of security on my wp-admin directory with a .

00:02:56.431 --> 00:02:58.349
htaccess and .

00:02:58.849 --> 00:03:04.762
htpasswd file. I also updated my password to a 40 character random string that even I can’t remember.

00:03:05.262 --> 00:03:13.574
Finally, I just erased the file that does theme editing in the admin interface since I never use it and it seems like a really weak vulnerability.

00:03:14.574 --> 00:03:18.489
So far, the pharma hack hasn’t resurfaced and it’s been about two weeks.

00:03:18.989 --> 00:03:25.542
I’m going to say that I’m slightly confident it won’t return (unless there’s another vulnerability in WordPress that pops up).

00:03:26.542 --> 00:03:31.417
I feel like I learned quite a bit about security while playing whack-a-mole with this hack.

00:03:31.917 --> 00:03:40.708
I got to look at the backdoor files and figure out how they were hidden and obfuscated, and eventually found what I think was the root of the problem in the WordPress theme editor.

00:03:41.208 --> 00:03:48.000
I also hacked together some scripts to show recently modified files (hacked together from stuff I found doing some searches).

00:03:48.500 --> 00:03:52.895
If I end up getting hacked like this again, I’ll probably be able to remove it faster.

00:03:53.895 --> 00:03:57.252
For a while, I was considering moving to Jekyll for my blog.

00:03:57.752 --> 00:04:05.903
But that seemed like a bit too much work moving posts and comments, and learning a new blogging system, especially for how infrequently I blog nowadays.

00:04:06.403 --> 00:04:13.755
For now, I will stick with WordPress with all of its vulnerabilities, which have hopefully been mitigated with the few extra precautions I’ve added.
