<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->

<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="" />
	<title>Cloning Zwift on iOS Part 5: SwiftUI and Combine</title>

	<!-- Open Graph Meta -->
	<meta content="Hung Truong: The Blog!" property="og:site_name" /><meta content="Cloning Zwift on iOS Part 5: SwiftUI and Combine" property="og:title" /><meta content="article" property="og:type" /><meta content="I recently switched teams at Amazon to one that is using SwiftUI and Combine, so I finally have a good excuse to learn the two. I am somewhat familiar with Functional Reactive Programming from using RxSwift at Lyft, but I've only really dabbled a bit with SwiftUI." property="og:description" /><meta content="https://www.hung-truong.com/blog/2021/05/02/zwift-clone-swiftui-combine/" property="og:url" /><meta
		content="2021-05-02T00:00:00+00:00"
		property="article:published_time"
	/>
	<meta content="https://www.hung-truong.com/blog/about/" property="article:author" /><meta
		content="https://www.hung-truong.com/blog/assets/img//wp-content/uploads/2021/Zswift_main_screen.png"
		property="og:image"
	/><!-- Twitter Cards -->
	<meta name="twitter:card" content="summary" />
	<meta name="twitter:site" content="@hungtruong" />
	<meta name="twitter:creator" content="@hungtruong" /><meta name="twitter:title" content="Cloning Zwift on iOS Part 5: SwiftUI and Combine" /><meta name="twitter:url" content="https://www.hung-truong.com/blog/2021/05/02/zwift-clone-swiftui-combine/" /><meta name="twitter:description" content="I recently switched teams at Amazon to one that is using SwiftUI and Combine, so I finally have a good excuse to learn the two. I am somewhat familiar with Functional Reactive Programming from using RxSwift at Lyft, but I've only really dabbled a bit with SwiftUI." /><meta
		name="twitter:image:src"
		content="https://www.hung-truong.com/blog/assets/img//wp-content/uploads/2021/Zswift_main_screen.png"
	/><!-- Favicon -->
	<link rel="icon" type="image/x-icon" href=""/>

	<!-- Come and get me RSS readers -->
	<link rel="alternate" type="application/rss+xml" title="Hung Truong: The Blog!"
	href="https://www.hung-truong.com/blog/feed.xml" />

	<!-- Stylesheet -->
	<link rel="stylesheet" href="/blog/assets/css/style.css" />

	<!-- Canonical URL -->
	<link
		rel="canonical"
		href="https://www.hung-truong.com/blog/2021/05/02/zwift-clone-swiftui-combine/"
	/><!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-248124-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-248124-2');
</script>
</head>

<body>

   <div class="header ">
     <div class="container">
         <h1 class="logo"><a href="/blog/">Hung Truong: The Blog!</a></h1>
         <nav class="nav-collapse">
             <ul class="noList"><li class="elementfirst">
                     <a href="/blog/index.html">Home</a>
                 </li><li class="element">
                     <a href="/blog/archives">Archives</a>
                 </li><li class="element">
                     <a href="/blog/about">About</a>
                 </li><li class="element">
                     <a href="/blog/contact">Contact</a>
                 </li><li class="elementlast">
                     <a href="/blog/speaking">Speaking</a>
                 </li></ul>
         </nav>
     </div>
 </div><!-- end .header -->

   <div class="content">
      <div class="container">
         <article class="post">
  <header>
    <h1 class="postTitle">Cloning Zwift on iOS Part 5: SwiftUI and Combine</h1>
    <p class="meta">May 02, 2021 | <span class="time">9</span> Minute Read</p>
  </header>

  <p><img src="/blog/wp-content/uploads/2021/Zswift_main_screen.png" /></p>

<p>I recently switched teams at Amazon to one that is using SwiftUI and Combine, so I finally have a good excuse to learn the two. I am somewhat familiar with Functional Reactive Programming from using RxSwift at Lyft, but I’ve only really dabbled a bit with SwiftUI.</p>

<p>I decided to spend some time last weekend (and this weekend) rewriting most of my Zwift clone app to use SwiftUI and Combine, and here’s some of the stuff I learned along the way.</p>

<!--more-->

<h3 id="moving-to-combine">Moving to Combine</h3>

<p>When I originally wrote the Zswift app, I didn’t really spend too much time on making sure the data model or architecture was the cleanest or anything. It’s really more of a hodgepodge of explorations and trying to get stuff to just work. Because of this, I probably violated a bunch of best practices. I had a “Workout” object that stored all of the different information that is needed to model a workout, but I also threw a bunch of logic and functions in there that probably didn’t make sense.</p>

<p>For example, the Workout had info on each segment of the workout, along with the duration and amount of power for the segment. As the workout progressed, I would store the elapsed time as well as a bunch of other state variables like the current segment and other variables like time in current segment that I used to drive the UI. Since I kept a bunch of variables to keep track of state, it’s possible that some of them would get out of sync with each other, and that would cause bugs. I think I had a bunch of off-by-one errors where I would reach the end of an index and crash or the time within a segment would be off by 1 so I’d be at 2:01/2:00 as far as progress went. Those kind of bugs.</p>

<p>In moving to Combine, my goal was to have the state of the workout flow from the one thing about the workout that actually changes: the elapsed time.</p>

<p>The elapsed time literally decides which segment I’m in, how long I’ve been working out (duh), how long I’ve been in the current segment, how hard I should be pedaling, etc. I ended up creating a separate class to keep track of the state of the workout, and just use the workout as a static definition of the workout. I could’ve done this before migrating to use Combine, but like I said, it was working and I didn’t feel the need to refactor.</p>

<p>In my current setup, the WorkoutManager has a @Published variable that keeps track of the elapsed time, and then I create a bunch of other publishers based on that one. I also have publishers that combine (imagine that) with other publishers. For example, I have a publisher called “timeInCurrentSegmentPublisher” that publishes the amount of time that I’ve been in the current segment. I combine this publisher with the “currentSegmentPublisher” which gives me the current segment, and use this to calculate the percentage progress for the current segment. I have to combine the two because each publisher only gives me one thing.</p>

<p>I weighed the benefits of creating publishers with multiple tuples of values, but in most cases it didn’t make sense, and I think it goes against the concept of making the streams composable, but I did end up making one for currentSegmentPublisher since it calculates the current segment and the current segment’s index at the same time anyway. Even as I’m writing about it now, I’m not sure if the better way is to create two different publishers since it’s kinda clunky to grab the desired value from the tuple.</p>

<p>Anyway, the result here is that my Workout object doesn’t have any more state at all. I could make it a struct but there’s some SwiftUI requirement for my Workout to be a class if I want to use it in a Modal view (which the workout detail is set up as) so for now I’ll just leave it as-is. I could also create a view model if I really wanted the Workout object to be a struct.</p>

<p>I’m sure I could optimize the Combine publishers even more but since they’re working now I’ll just leave them.</p>

<h3 id="swiftui">SwiftUI</h3>
<figure>
	<img src="/blog/wp-content/uploads/2021/xcode_swiftui_previews.png" />
	<figcaption>An example of the live SwiftUI previews that update automatically</figcaption>
</figure>

<p>The general opinion that I see from others about SwiftUI is that the more people use it, the more they like it, and that it really forces you to rethink how you define interfaces. I heard this a million times but until you actually play around with it in a non-trivial example I feel like it’s hard to really understand it.</p>

<p>The gist is that SwiftUI is a declarative way to define your UIs instead of an Imperative way. The difference can seem subtle until you start doing stuff. What it means is that instead of telling the computer how to do something, you just tell it what you want. If that’s confusing then yeah, actually it is confusing.</p>

<p>I guess to put it another way, in UIKit you can define views as objects, give them properties, add them to a parent view and then set some constraints on them. In this imperative example, it’s up to you to define every step to the computer to tell it what to do, and hope that your interface matches what you were thinking.</p>

<p>In a declarative syntax, you can describe what you want, and add some modifiers to it if you need to have more control over the actual output. From there, you also define state variables or observed objects that the SwiftUI view will use to actually come up with the completed interface.</p>

<p>Imagine that you want to show a list of dog breeds. In an imperative system you need to set up the collection view controller, fill out your functions for “cellAtIndex” and “didSelectCellAtIndex” etc, and supply the cells. In a declarative system you can say “I want a list of ‘DogViews’ that use the ‘Dog’ model” and define a “NavigationLink” to define what happens when you tap on the cell.</p>

<p>The interesting part to me was that the SwiftUI view is an immutable struct, so you can’t modify the view as you would a UIView when states change. Of course your view can respond to changes in the data model, but all of those states need to be determined at compile time rather than runtime.</p>

<p>One of the best parts about SwiftUI is how the “live” previews work. They aren’t exactly real time, but fast enough that the feedback loop between writing UI code and seeing the result is very tight. In the past I’ve had to write code to update a UI (or use Interface Builder), then build and run, and go to the part of the app where the UI I changed was. This could mean it would be a few seconds or minutes before I saw whether the change I just wrote actually worked. In SwiftUI you make a change and once you’re done writing it, the preview window will show it. The system isn’t perfect, of course, as sometimes it can’t compile and you need to reenable the live preview. But it’s really the best tradeoff between the WYSIWYG style of Interface Builder and the readability of programmatic view code. I’m sure the tools will improve in the future, and I’m quite certain that this ease of previewing code will be one of the factors that will motivate people to switch to SwiftUI.</p>

<h3 id="the-workout-view">The Workout View</h3>

<p><img src="/blog/wp-content/uploads/2021/workout_view.png" /></p>

<p>I modeled my original interface after the Zwift app. In the Zwift app, you can see the workout represented as a bunch of rectangles representing segments that get taller when the target power is higher. The width is determined by the length of the segment.</p>

<p>I basically copied this and implemented it with a UIStackView and percentage constraints. I thought it was pretty cool but one thing that bothered me is the warmup and cooldown segments. Those have a starting value and ending value that are different (warmups start lower and end higher). I didn’t want to spend too much time drawing the start of the rectangle to be lower than the end (plus it wouldn’t technically be a rectangle at that point) so I just used the “lower” value and set them as flat rectangles.</p>

<p>I decided to practice some custom drawing in SwiftUi to properly draw the warmup and cooldown segments and I’m pretty happy with the result. The view is drawn by taking the desired start and end heights and width, and drawing a path with it. I used “path.addArc” to get a nice rounded corner effect, though it isn’t perfect. I also draw a 1px wide vertical line to show where I am in the workout by offsetting it from the left by a percentage of the view’s width.</p>

<p>I also went ahead and stole the color scheme from the Zwift app which makes it look a bit more polished.</p>

<h3 id="the-workout-detail">The Workout Detail</h3>

<p><img src="/blog/wp-content/uploads/2021/side_by_side.png" /></p>

<p>In addition to updating the workout representation view, I also decided to just overhaul the entire workout detail view (the view I see when I’m in a workout). The old interface was pretty basic with a bunch of grids and text boxes that didn’t really have any visual separation from each other, aside from the size and distribution of the labels.</p>

<p>I ended up experimenting with the “GroupBox” component of SwiftUI which is pretty simple but makes a big difference just in terms of separating out the different interface elements. I also added some accent colors and icons to some of the text labels, and I added progress indicators to the segment time and elapsed time sections just to make them stand out more. Overall I really like the new workout detail view which is good since I’m literally the only person who uses this app.</p>

<p>I have some more ideas for enhancements, like recreating the Apple Watch heart rate animation which shows a heart pulsing at your actual heart rate. The animation seamlessly updates when your heart rate changes, which is pretty cool.</p>

<p>I also want to add some more tracking informtion, like a histogram (maybe with candlestick charts or sparklines) of the wattage and heart rate info. This would be nice to have but the HealthKit integration already includes the heart rate chart. And I don’t know if I care too much about the wattage graph.</p>



  <!-- COMMENTS -->
  

  <div class="comment-form">
    <h3>Leave a Comment</h3>
    <p><em>Comments are moderated and won't appear immediately after submission.</em></p>
    <form method="POST" action="https://staticman.hung-truong.com/v3/entry/github/hungtruong/jekyll-blog/main/comments" class="comment-form-fields" id="comment-form">
  <input name="options[slug]" type="hidden" value="zwift-clone-swiftui-combine">
  
  <div class="field">
    <label for="comment-name">Name *</label>
    <input type="text" id="comment-name" name="fields[name]" class="full-width" required>
  </div>
  
  <div class="field">
    <label for="comment-email">Email *</label>
    <input type="email" id="comment-email" name="fields[email]" class="full-width" required>
  </div>
  
  <div class="field">
    <label for="comment-url">Website</label>
    <input type="url" id="comment-url" name="fields[url]" class="full-width">
  </div>
  
  <div class="field">
    <label for="comment-message">Comment *</label>
    <textarea id="comment-message" name="fields[message]" rows="5" class="full-width" required></textarea>
  </div>
  
  <button type="submit" class="button" id="comment-submit">Submit Comment</button>
</form>

<div id="comment-success" style="display: none;" class="comment-message comment-message-success">
  <div>
    <h4>Thank you for your comment!</h4>
    <p>Your comment has been submitted and will be published after manual approval.</p>
  </div>
</div>

<div id="comment-error" style="display: none;" class="comment-message comment-message-error">
  <div>
    <h4>Submission Error</h4>
    <p>There was an error submitting your comment. Please try again.</p>
  </div>
</div>
  </div>

  <!-- POST NAVIGATION -->
  <div class="postNav clearfix">
    
    <a class="prev image"
      href="/blog/2020/05/12/reverse-engineering-quibi/"><span>&laquo;&nbsp;Reverse Engineering Quibi: Protocol Buffers and HLS Streaming</span>
      
      <img src="/blog/wp-content/uploads/2020/Quibi_Logo.png" alt="">
      
    </a>
    
    
    <a class="next image" href="/blog/2022/01/10/i-created-a-robot-to-solve-wordle-for-me/"><span>I Created a Robot to Solve Wordle For Me&nbsp;&raquo;</span>
      
      <img src="/blog/wp-content/uploads/2022/WordleScreenshot.png" alt="">
      
    </a>
    
  </div>
  </div>
      </div>
   </div><!-- end .content -->

   <div class="footer">
	<div class="container">
		<p class="copy">&copy; 2025 <a href="http://www.hung-truong.com/blog/">Hung Truong</a></p>

		<div class="footer-links">
			<ul class="noList"><li>
	<a href="https://twitter.com/hungtruong" target="_blank">
		<svg
			id="twitter"
			class="custom-icon"
			version="1.1"
			xmlns="http://www.w3.org/2000/svg"
			xmlns:xlink="http://www.w3.org/1999/xlink"
			viewBox="0 0 100 100"
			style="height: 30px; width: 30px;"
		>
			<circle
				class="outer-shape"
				cx="50"
				cy="50"
				r="48"
				style="opacity: 1;"
			></circle>
			<path
				class="inner-shape"
				style="opacity: 1;"
				transform="translate(25,25) scale(0.5)"
				d="M99.001,19.428c-3.606,1.608-7.48,2.695-11.547,3.184c4.15-2.503,7.338-6.466,8.841-11.189 c-3.885,2.318-8.187,4-12.768,4.908c-3.667-3.931-8.893-6.387-14.676-6.387c-11.104,0-20.107,9.054-20.107,20.223 c0,1.585,0.177,3.128,0.52,4.609c-16.71-0.845-31.525-8.895-41.442-21.131C6.092,16.633,5.1,20.107,5.1,23.813 c0,7.017,3.55,13.208,8.945,16.834c-3.296-0.104-6.397-1.014-9.106-2.529c-0.002,0.085-0.002,0.17-0.002,0.255 c0,9.799,6.931,17.972,16.129,19.831c-1.688,0.463-3.463,0.71-5.297,0.71c-1.296,0-2.555-0.127-3.783-0.363 c2.559,8.034,9.984,13.882,18.782,14.045c-6.881,5.424-15.551,8.657-24.971,8.657c-1.623,0-3.223-0.096-4.796-0.282 c8.898,5.738,19.467,9.087,30.82,9.087c36.982,0,57.206-30.817,57.206-57.543c0-0.877-0.02-1.748-0.059-2.617 C92.896,27.045,96.305,23.482,99.001,19.428z"
			></path>
		</svg>
	</a>
</li>
<li>
	<a href="https://github.com/hungtruong" target="_blank">
		<svg
			id="github"
			class="custom-icon"
			version="1.1"
			xmlns="http://www.w3.org/2000/svg"
			xmlns:xlink="http://www.w3.org/1999/xlink"
			viewBox="0 0 100 100"
			style="height: 30px; width: 30px;"
		>
			<circle
				class="outer-shape"
				cx="50"
				cy="50"
				r="48"
				style="opacity: 1;"
			></circle>
			<path
				class="inner-shape"
				style="opacity: 1;"
				transform="translate(25,25) scale(0.5)"
				d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M79.099,79.099 c-3.782,3.782-8.184,6.75-13.083,8.823c-1.245,0.526-2.509,0.989-3.79,1.387v-7.344c0-3.86-1.324-6.699-3.972-8.517 c1.659-0.16,3.182-0.383,4.57-0.67c1.388-0.287,2.855-0.702,4.402-1.245c1.547-0.543,2.935-1.189,4.163-1.938 c1.228-0.75,2.409-1.723,3.541-2.919s2.082-2.552,2.847-4.067s1.372-3.334,1.818-5.455c0.446-2.121,0.67-4.458,0.67-7.01 c0-4.945-1.611-9.155-4.833-12.633c1.467-3.828,1.308-7.991-0.478-12.489l-1.197-0.143c-0.829-0.096-2.321,0.255-4.474,1.053 c-2.153,0.798-4.57,2.105-7.249,3.924c-3.797-1.053-7.736-1.579-11.82-1.579c-4.115,0-8.039,0.526-11.772,1.579 c-1.69-1.149-3.294-2.097-4.809-2.847c-1.515-0.75-2.727-1.26-3.637-1.532c-0.909-0.271-1.754-0.439-2.536-0.503 c-0.782-0.064-1.284-0.079-1.507-0.048c-0.223,0.031-0.383,0.064-0.478,0.096c-1.787,4.53-1.946,8.694-0.478,12.489 c-3.222,3.477-4.833,7.688-4.833,12.633c0,2.552,0.223,4.889,0.67,7.01c0.447,2.121,1.053,3.94,1.818,5.455 c0.765,1.515,1.715,2.871,2.847,4.067s2.313,2.169,3.541,2.919c1.228,0.751,2.616,1.396,4.163,1.938 c1.547,0.543,3.014,0.957,4.402,1.245c1.388,0.287,2.911,0.511,4.57,0.67c-2.616,1.787-3.924,4.626-3.924,8.517v7.487 c-1.445-0.43-2.869-0.938-4.268-1.53c-4.899-2.073-9.301-5.041-13.083-8.823c-3.782-3.782-6.75-8.184-8.823-13.083 C9.934,60.948,8.847,55.56,8.847,50s1.087-10.948,3.231-16.016c2.073-4.899,5.041-9.301,8.823-13.083s8.184-6.75,13.083-8.823 C39.052,9.934,44.44,8.847,50,8.847s10.948,1.087,16.016,3.231c4.9,2.073,9.301,5.041,13.083,8.823 c3.782,3.782,6.75,8.184,8.823,13.083c2.143,5.069,3.23,10.457,3.23,16.016s-1.087,10.948-3.231,16.016 C85.848,70.915,82.88,75.317,79.099,79.099L79.099,79.099z"
			></path>
		</svg>
	</a>
</li>
<li>
	<a href="https://www.youtube.com/@techsistentialcrisis" target="_blank">
		<svg
			id="youtube"
			class="custom-icon"
			version="1.1"
			xmlns="http://www.w3.org/2000/svg"
			xmlns:xlink="http://www.w3.org/1999/xlink"
			viewBox="0 0 100 100"
			style="height: 30px; width: 30px;"
		>
			<circle
				class="outer-shape"
				cx="50"
				cy="50"
				r="48"
				style="opacity: 1;"
			></circle>
			<path fill="#FFF" fill-rule="evenodd" clip-rule="evenodd"
				d="M18.168 19.0028C20.4724 19.0867 22.41 17.29 22.5 14.9858V9.01982C22.41 6.71569 20.4724 4.91893 18.168 5.00282H6.832C4.52763 4.91893 2.58998 6.71569 2.5 9.01982V14.9858C2.58998 17.29 4.52763 19.0867 6.832 19.0028H18.168Z"
				stroke="#000000" stroke-width="0"
				stroke-linecap="round" stroke-linejoin="round"
				transform="translate(22,22) scale(2.3)"></path>
			<path class="outer-shape" fill-rule="evenodd" clip-rule="evenodd"
				d="M12.008 9.17784L15.169 11.3258C15.3738 11.4454 15.4997 11.6647 15.4997 11.9018C15.4997 12.139 15.3738 12.3583 15.169 12.4778L12.008 14.8278C11.408 15.2348 10.5 14.8878 10.5 14.2518V9.75184C10.5 9.11884 11.409 8.77084 12.008 9.17784Z"
				stroke-linecap="round" stroke-linejoin="round"
				transform="translate(22,22) scale(2.3)"></path>
		</svg>
	</a>
</li>
<li>
	<a href="mailto:hung@hung-truong.com" target="_blank">
		<svg
			id="mail"
			class="custom-icon"
			version="1.1"
			xmlns="http://www.w3.org/2000/svg"
			xmlns:xlink="http://www.w3.org/1999/xlink"
			viewBox="0 0 100 100"
			style="height: 30px; width: 30px;"
		>
			<circle
				class="outer-shape"
				cx="50"
				cy="50"
				r="48"
				style="opacity: 1;"
			></circle>
			<path
				class="inner-shape"
				style="opacity: 1;"
				transform="translate(25,25) scale(0.5)"
				d="M50,1C22.938,1,1,22.938,1,50s21.938,49,49,49s49-21.938,49-49S77.062,1,50,1z M25.5,25.5h49 c0.874,0,1.723,0.188,2.502,0.542L50,57.544L22.998,26.041C23.777,25.687,24.626,25.499,25.5,25.5L25.5,25.5z M19.375,68.375v-36.75 c0-0.128,0.005-0.256,0.014-0.383l17.96,20.953L19.587,69.958C19.448,69.447,19.376,68.916,19.375,68.375L19.375,68.375z M74.5,74.5 h-49c-0.541,0-1.072-0.073-1.583-0.212l17.429-17.429L50,66.956l8.653-10.096l17.429,17.429C75.572,74.427,75.041,74.5,74.5,74.5 L74.5,74.5z M80.625,68.375c0,0.541-0.073,1.072-0.211,1.583L62.652,52.195l17.96-20.953c0.008,0.127,0.014,0.255,0.014,0.383 L80.625,68.375L80.625,68.375z"
			></path>
		</svg>
	</a>
</li>
</ul>
		</div>
	</div>
</div>
<!-- end .footer -->
      <!-- Default Statcounter code for Hung Truong: The Blog!
   http://www.hung-truong.com/blog/ -->
      <script type="text/javascript">
            var sc_project = 1262196;
            var sc_invisible = 1;
            var sc_security = "4af14454";
            var scJsHost = (("https:" == document.location.protocol) ?
                  "https://secure." : "http://www.");
            document.write("<sc" + "ript type='text/javascript' src='" +
                  scJsHost +
                  "statcounter.com/counter/counter.js'></" + "script>");
      </script>
      <!-- End of Statcounter Code -->
   <!-- Add jQuery and other scripts -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src=/blog/assets/js/jquery-1.11.2.min.js><\/script>')</script>
<script src="/blog/assets/js/dropcap.min.js"></script>
<script src="/blog/assets/js/responsive-nav.min.js"></script>
<script src="/blog/assets/js/scripts.js"></script>

</body>

</html>
